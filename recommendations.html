<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>DietFlow — Recommendations</title>
  <link rel="stylesheet" href="./assets/style.css"/>
</head>

<body>
<header>
  <div class="container nav">
    <div class="brand"><a href="./index.html">dietflow<span>.</span></a></div>
    <div class="links">
      <a href="./recommendations.html" class="active">recommendations</a>
      <a href="./plan.html">weekly plan</a>
      <a href="./analytics.html">analytics</a>
    </div>
  </div>
</header>

<main class="container">
  <div class="sectionTitle">
    <h2>Recommendations</h2>
    <div class="hint" id="countInfo">Loading…</div>
  </div>

  <div class="filters">
    <div class="row">
      <input id="q" class="input" placeholder="Search: salad, chicken, rice..." />
      <select id="sort" class="select">
        <option value="score">Best score</option>
        <option value="calories">Lowest calories</option>
        <option value="protein">Highest protein</option>
      </select>

      <div class="sliderWrap">
        <label><span>Max calories</span><b id="calMaxVal">1200</b></label>
        <input id="calMax" type="range" min="200" max="2000" step="10" value="1200"/>
      </div>

      <div class="sliderWrap">
        <label><span>Min protein</span><b id="pMinVal">0</b></label>
        <input id="pMin" type="range" min="0" max="150" step="1" value="0"/>
      </div>

      <div class="sliderWrap">
        <label><span>Max carbs</span><b id="cMaxVal">200</b></label>
        <input id="cMax" type="range" min="0" max="300" step="5" value="200"/>
      </div>

      <div class="sliderWrap">
        <label><span>Max fat</span><b id="fMaxVal">120</b></label>
        <input id="fMax" type="range" min="0" max="200" step="5" value="120"/>
      </div>
    </div>
  </div>

  <!-- ✅ Charts (optional but beautiful) -->
  <section class="card" style="margin-top:18px;">
    <h3 style="margin-bottom:8px;">Recommendation Insights</h3>
    <div id="recCharts" style="height:420px;"></div>
    <div class="hint" id="chartHint" style="margin-top:8px;">Charts will load when data is available.</div>
  </section>

  <div id="cards" class="cards"></div>

  <div class="footer">
    Data source:
    <code id="srcCode"></code>
  </div>
</main>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>

<!-- Your existing app logic (CSV renderer) -->
<script src="./assets/app.js"></script>

<script>
  /**
   * ✅ Strategy:
   * 1) Try to load local JSON first (fast on Vercel): /data/recommendations.json
   * 2) If not present, fallback to your GitHub RAW CSV (current approach)
   */

  // CSV fallback (your current working source)
  const CSV_FALLBACK =
    "https://raw.githubusercontent.com/iamjahanzaibch/dietflow/main/top_recommendations_lunch.csv";

  // JSON primary (you will add this later in repo: /data/recommendations.json)
  const JSON_PRIMARY = "./data/recommendations.json";

  function setSourceLabel(text) {
    document.getElementById("srcCode").textContent = text;
  }

  async function tryLoadJSON() {
    const res = await fetch(JSON_PRIMARY, { cache: "no-store" });
    if (!res.ok) throw new Error("JSON not found");
    const obj = await res.json();
    if (!obj || !Array.isArray(obj.recommendations)) throw new Error("Invalid JSON schema");
    return obj;
  }

  function toCSVLikeRowsFromJSON(obj) {
    // Convert JSON recommendations -> shape that your existing app.js expects
    return obj.recommendations.map(r => ({
      name: r.name ?? r.Name ?? "",
      category: r.category ?? r.Category ?? "",
      calories: r.calories ?? r.Calories ?? "",
      protein: r.protein ?? r.Protein ?? "",
      carbs: r.carbs ?? r.Carbs ?? "",
      fat: r.fat ?? r.Fat ?? "",
      final_score: r.final_score ?? r.score ?? r.Score ?? ""
    }));
  }

  function drawChartsFromRows(rows) {
    try {
      const calories = rows.map(r => Number(r.calories)).filter(v => Number.isFinite(v) && v > 0);
      const scores = rows.map(r => Number(r.final_score)).filter(v => Number.isFinite(v));
      const protein = rows.map(r => Number(r.protein)).filter(v => Number.isFinite(v));

      const traces = [
        { x: calories, type: "histogram", nbinsx: 30, name: "Calories" },
        { x: scores, type: "histogram", nbinsx: 30, name: "Scores" }
      ];

      // If protein exists, add it
      if (protein.length > 10) {
        traces.push({ x: protein, type: "histogram", nbinsx: 30, name: "Protein" });
      }

      Plotly.newPlot("recCharts", traces, {
        margin: { t: 10, l: 45, r: 20, b: 45 },
        barmode: "overlay",
        xaxis: { title: "Value" },
        yaxis: { title: "Count" },
        legend: { orientation: "h" }
      }, { responsive: true });

      document.getElementById("chartHint").textContent = "Loaded charts from recommendation data.";
    } catch (e) {
      document.getElementById("chartHint").textContent = "Charts could not be rendered for this dataset.";
    }
  }

  async function boot() {
    // Bind slider labels
    const bindVal = (id, outId) => {
      const el = document.getElementById(id);
      const out = document.getElementById(outId);
      out.textContent = el.value;
      el.addEventListener("input", () => out.textContent = el.value);
    };
    bindVal("calMax", "calMaxVal");
    bindVal("pMin", "pMinVal");
    bindVal("cMax", "cMaxVal");
    bindVal("fMax", "fMaxVal");

    // Try JSON first
    try {
      const json = await tryLoadJSON();
      const rows = toCSVLikeRowsFromJSON(json);

      // ✅ Feed rows into your existing renderer
      // Your app.js currently expects a CSV URL; so we inject a tiny trick:
      window.__DIETFLOW_INLINE_ROWS__ = rows;

      // Provide a source label
      setSourceLabel("Local JSON: " + JSON_PRIMARY);

      // If your app.js supports inline rows, use it; otherwise fallback to CSV
      if (typeof window.initRecommendationsFromRows === "function") {
        await window.initRecommendationsFromRows(rows);
        drawChartsFromRows(rows);
        return;
      }

      // If your app.js does NOT support inline rows yet:
      // we still draw charts + continue with CSV renderer for cards
      drawChartsFromRows(rows);
      throw new Error("app.js has no initRecommendationsFromRows(); using CSV fallback for cards.");
    } catch (e) {
      // Fallback: your current CSV path (works today)
      window.RECOMMENDATIONS_CSV_URL = CSV_FALLBACK;
      setSourceLabel("GitHub CSV: " + CSV_FALLBACK);

      window.initRecommendations().catch(err => {
        document.getElementById("countInfo").textContent = "Failed to load data";
        document.getElementById("cards").innerHTML =
          `<div class="card"><h3>Error</h3><p>${String(err.message)}</p></div>`;
      });
    }
  }

  boot();
</script>

</body>
</html>
